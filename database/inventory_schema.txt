// Prisma Schema for Universal Inventory Management System
// Supports: Grocery, Medical, Restaurant, Retail, Wholesale, etc.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // Can switch to "mysql" or "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. BUSINESS & USER MANAGEMENT
// ============================================

model Business {
  id              String   @id @default(uuid())
  name            String
  businessType    String   // "grocery", "medical", "restaurant", "retail"
  address         String?
  phone           String?
  email           String?
  gstNumber       String?  @unique
  logo            String?
  currency        String   @default("INR")
  taxEnabled      Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  users           User[]
  categories      Category[]
  products        Product[]
  suppliers       Supplier[]
  customers       Customer[]
  purchases       Purchase[]
  sales           Sale[]
  expenses        Expense[]
}

model User {
  id              String   @id @default(uuid())
  businessId      String
  name            String
  email           String   @unique
  password        String
  role            String   // "admin", "manager", "cashier", "staff"
  phone           String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  sales           Sale[]
  purchases       Purchase[]
}

// ============================================
// 2. PRODUCT MANAGEMENT (Flexible Structure)
// ============================================

model Category {
  id              String   @id @default(uuid())
  businessId      String
  name            String
  description     String?
  parentId        String?  // For nested categories
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  business        Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  parent          Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[] @relation("CategoryHierarchy")
  products        Product[]
}

model Product {
  id              String   @id @default(uuid())
  businessId      String
  categoryId      String?
  
  // Basic Info
  name            String
  description     String?
  sku             String?  @unique // Stock Keeping Unit
  barcode         String?  @unique
  image           String?
  
  // Pricing
  costPrice       Float    // Purchase price
  sellingPrice    Float    // Selling price
  mrp             Float?   // Maximum Retail Price
  discountPercent Float?   @default(0)

  hasVariants     Boolean  @default(false) 
  
  
  // Inventory
  unit            String   // "piece", "kg", "liter", "box", "dozen"
  minStockLevel   Float?   @default(0) // Reorder level
  maxStockLevel   Float?
  currentStock    Float    @default(0)
  
  // Tax
  taxPercent      Float    @default(0)
  hsnCode         String?  // HSN Code for GST (India)
  
  // Tracking
  trackBatch      Boolean  @default(false) // For expiry tracking
  trackSerial     Boolean  @default(false) // For serial number tracking
  
  // Status
  isActive        Boolean  @default(true)
  isComposite     Boolean  @default(false) // For recipes/combinations
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category        Category? @relation(fields: [categoryId], references: [id])
  
  batches         Batch[]
  variants        ProductVariant[]
  customFields    ProductCustomField[]
  purchaseItems   PurchaseItem[]
  saleItems       SaleItem[]
  stockMovements  StockMovement[]
  compositeItems  CompositeProduct[] @relation("ParentProduct")
  childItems      CompositeProduct[] @relation("ChildProduct")
}

// For products with variants (size, color, etc.)
model ProductVariant {
  id              String   @id @default(uuid())
  productId       String
  name            String   // "Small", "Medium", "Large" or "Red", "Blue"
  sku             String?  @unique
  barcode         String?  @unique
  costPrice       Float
  sellingPrice    Float
  currentStock    Float    @default(0)
  isActive        Boolean  @default(true)

  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  saleItems       SaleItem[]
}

// For flexible custom fields (medicine: composition, food: allergens, etc.)
model ProductCustomField {
  id              String   @id @default(uuid())
  productId       String
  fieldName       String   // "composition", "manufacturer", "allergens"
  fieldValue      String
  
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// For combo products (meal combos, medicine kits, etc.)
model CompositeProduct {
  id              String   @id @default(uuid())
  parentId        String   // The combo product
  childId         String   // Individual product
  quantity        Float    // How many units needed

  parent          Product  @relation("ParentProduct", fields: [parentId], references: [id], onDelete: Cascade)
  child           Product  @relation("ChildProduct", fields: [childId], references: [id], onDelete: Cascade)
}

// ============================================
// 3. BATCH & EXPIRY TRACKING
// ============================================

model Batch {
  id              String   @id @default(uuid())
  productId       String
  batchNumber     String
  manufacturingDate DateTime?
  expiryDate      DateTime?
  quantity        Float
  costPrice       Float
  sellingPrice    Float
  supplierName    String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  saleItems       SaleItem[]
}

// ============================================
// 4. SUPPLIER & CUSTOMER MANAGEMENT
// ============================================

model Supplier {
  id              String   @id @default(uuid())
  businessId      String
  name            String
  contactPerson   String?
  phone           String?
  email           String?
  address         String?
  gstNumber       String?
  openingBalance  Float    @default(0)
  currentBalance  Float    @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  purchases       Purchase[]
}

model Customer {
  id              String   @id @default(uuid())
  businessId      String
  name            String
  phone           String?  @unique
  email           String?
  address         String?
  gstNumber       String?
  openingBalance  Float    @default(0)
  currentBalance  Float    @default(0)
  loyaltyPoints   Float    @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  sales           Sale[]
}

// ============================================
// 5. PURCHASE MANAGEMENT
// ============================================

model Purchase {
  id              String   @id @default(uuid())
  businessId      String
  supplierId      String
  userId          String
  
  purchaseNumber  String   @unique // Auto-generated: PUR-001
  purchaseDate    DateTime @default(now())
  
  subtotal        Float
  discountAmount  Float    @default(0)
  taxAmount       Float    @default(0)
  totalAmount     Float
  
  paidAmount      Float    @default(0)
  dueAmount       Float    @default(0)
  
  paymentMethod   String?  // "cash", "card", "upi", "cheque", "credit"
  paymentStatus   String   @default("pending") // "pending", "partial", "paid"
  
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  user            User     @relation(fields: [userId], references: [id])
  
  items           PurchaseItem[]
  payments        Payment[]
}

model PurchaseItem {
  id              String   @id @default(uuid())
  purchaseId      String
  productId       String
  
  quantity        Float
  unit            String
  costPrice       Float    // Price per unit
  sellingPrice    Float    // To update product selling price
  
  discountPercent Float    @default(0)
  taxPercent      Float    @default(0)
  
  subtotal        Float
  totalAmount     Float
  
  batchNumber     String?
  expiryDate      DateTime?

  purchase        Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id])
}

// ============================================
// 6. SALES & BILLING
// ============================================

model Sale {
  id              String   @id @default(uuid())
  businessId      String
  customerId      String?
  userId          String
  
  invoiceNumber   String   @unique // Auto-generated: INV-001
  saleDate        DateTime @default(now())
  
  subtotal        Float
  discountAmount  Float    @default(0)
  taxAmount       Float    @default(0)
  totalAmount     Float
  
  paidAmount      Float    @default(0)
  dueAmount       Float    @default(0)
  
  paymentMethod   String?  // "cash", "card", "upi", "cheque", "credit"
  paymentStatus   String   @default("pending") // "pending", "partial", "paid"
  
  saleType        String   @default("retail") // "retail", "wholesale", "online"
  deliveryStatus  String?  // "pending", "delivered", "cancelled"
  
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  business        Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer        Customer? @relation(fields: [customerId], references: [id])
  user            User      @relation(fields: [userId], references: [id])
  
  items           SaleItem[]
  payments        Payment[]
  returns         SaleReturn[]
}

model SaleItem {
  id              String   @id @default(uuid())
  saleId          String
  productId       String
  variantId       String?
  batchId         String?
  
  quantity        Float
  unit            String
  sellingPrice    Float    // Price per unit
  
  discountPercent Float    @default(0)
  taxPercent      Float    @default(0)
  
  subtotal        Float
  totalAmount     Float
  
  serialNumbers   String?  // Comma-separated for tracked items

  sale            Sale            @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product         Product         @relation(fields: [productId], references: [id])
  variant         ProductVariant? @relation(fields: [variantId], references: [id])
  batch           Batch?          @relation(fields: [batchId], references: [id])
}

// ============================================
// 7. PAYMENT TRACKING
// ============================================

model Payment {
  id              String   @id @default(uuid())
  businessId      String
  
  purchaseId      String?
  saleId          String?
  
  amount          Float
  paymentMethod   String   // "cash", "card", "upi", "cheque", "bank_transfer"
  paymentDate     DateTime @default(now())
  
  referenceNumber String?
  notes           String?
  
  createdAt       DateTime @default(now())

  purchase        Purchase? @relation(fields: [purchaseId], references: [id])
  sale            Sale?     @relation(fields: [saleId], references: [id])
}

// ============================================
// 8. RETURNS MANAGEMENT
// ============================================

model SaleReturn {
  id              String   @id @default(uuid())
  saleId          String
  
  returnNumber    String   @unique
  returnDate      DateTime @default(now())
  returnAmount    Float
  reason          String?
  refundMethod    String?  // "cash", "credit_note"
  
  createdAt       DateTime @default(now())

  sale            Sale     @relation(fields: [saleId], references: [id])
  items           SaleReturnItem[]
}

model SaleReturnItem {
  id              String   @id @default(uuid())
  returnId        String
  productId       String
  
  quantity        Float
  returnPrice     Float
  totalAmount     Float

  return          SaleReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)
}

// ============================================
// 9. STOCK MANAGEMENT & AUDIT
// ============================================

model StockMovement {
  id              String   @id @default(uuid())
  productId       String
  
  type            String   // "purchase", "sale", "return", "adjustment", "damage", "transfer"
  quantity        Float    // Positive for IN, Negative for OUT
  
  beforeStock     Float
  afterStock      Float
  
  referenceType   String?  // "purchase", "sale", "adjustment"
  referenceId     String?
  
  notes           String?
  createdAt       DateTime @default(now())

  product         Product  @relation(fields: [productId], references: [id])
}

model StockAdjustment {
  id              String   @id @default(uuid())
  productId       String
  
  adjustmentType  String   // "increase", "decrease"
  quantity        Float
  reason          String   // "damage", "theft", "expired", "found", "error"
  
  notes           String?
  createdAt       DateTime @default(now())
}

// ============================================
// 10. EXPENSES & REPORTING
// ============================================

model Expense {
  id              String   @id @default(uuid())
  businessId      String
  
  categoryName    String   // "rent", "electricity", "salary", "maintenance"
  amount          Float
  expenseDate     DateTime @default(now())
  
  paymentMethod   String?
  notes           String?
  receiptImage    String?
  
  createdAt       DateTime @default(now())

  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

// ============================================
// 11. SETTINGS & CONFIGURATION
// ============================================

model Settings {
  id              String   @id @default(uuid())
  businessId      String   @unique
  
  // Invoice Settings
  invoicePrefix   String   @default("INV")
  invoiceFooter   String?
  
  // Tax Settings
  defaultTaxRate  Float    @default(0)
  
  // Receipt Printer
  printerName     String?
  paperSize       String   @default("80mm")
  
  // Notifications
  lowStockAlert   Boolean  @default(true)
  expiryAlert     Boolean  @default(true)
  expiryAlertDays Int      @default(30)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}